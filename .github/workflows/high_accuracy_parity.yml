name: High Accuracy Parity

on:
  workflow_dispatch:
  schedule:
    - cron: "30 4 * * *"

permissions:
  contents: read

concurrency:
  group: high-accuracy-parity-${{ github.ref }}
  cancel-in-progress: true

jobs:
  kh-strict-parity:
    name: KH strict parity (high accuracy, non-blocking)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -e .

      - name: Run strict KH high-accuracy parity benchmark
        run: |
          python tools/reproduce_flat_disk_one_leaflet.py \
            --fixture tests/fixtures/kozlov_1disk_3d_free_disk_theory_parity.yaml \
            --parameterization kh_physical \
            --smoothness-model splay_twist \
            --theta-mode optimize \
            --optimize-preset kh_strict_outerfield_averaged \
            --tilt-mass-mode-in consistent \
            --outer-mode disabled \
            --output benchmarks/outputs/diagnostics/high_accuracy_parity_report.yaml

      - name: Run fixed-theta KH term audit at theta_star
        run: |
          python - <<'PY'
          from pathlib import Path
          import yaml
          from tools.diagnostics.flat_disk_kh_term_audit import run_flat_disk_kh_term_audit

          report_path = Path("benchmarks/outputs/diagnostics/high_accuracy_parity_report.yaml")
          report = yaml.safe_load(report_path.read_text(encoding="utf-8"))
          theta_star = float(report["mesh"]["theta_star"])
          meta = report["meta"]

          audit = run_flat_disk_kh_term_audit(
              fixture="tests/fixtures/kozlov_1disk_3d_free_disk_theory_parity.yaml",
              refine_level=int(meta["refine_level"]),
              outer_mode="disabled",
              smoothness_model="splay_twist",
              kappa_physical=10.0,
              kappa_t_physical=10.0,
              radius_nm=7.0,
              length_scale_nm=15.0,
              drive_physical=(2.0 / 0.7),
              theta_values=(theta_star,),
              tilt_mass_mode_in="consistent",
              rim_local_refine_steps=int(meta["rim_local_refine_steps"]),
              rim_local_refine_band_lambda=float(meta["rim_local_refine_band_lambda"]),
              outer_local_refine_steps=int(meta["outer_local_refine_steps"]),
              outer_local_refine_rmin_lambda=float(meta["outer_local_refine_rmin_lambda"]),
              outer_local_refine_rmax_lambda=float(meta["outer_local_refine_rmax_lambda"]),
              local_edge_flip_steps=int(meta["local_edge_flip_steps"]),
              local_edge_flip_rmin_lambda=float(meta["local_edge_flip_rmin_lambda"]),
              local_edge_flip_rmax_lambda=float(meta["local_edge_flip_rmax_lambda"]),
              outer_local_vertex_average_steps=int(meta["outer_local_vertex_average_steps"]),
              outer_local_vertex_average_rmin_lambda=float(meta["outer_local_vertex_average_rmin_lambda"]),
              outer_local_vertex_average_rmax_lambda=float(meta["outer_local_vertex_average_rmax_lambda"]),
          )

          out_path = Path("benchmarks/outputs/diagnostics/high_accuracy_parity_term_audit.yaml")
          out_path.parent.mkdir(parents=True, exist_ok=True)
          out_path.write_text(yaml.safe_dump(audit, sort_keys=False), encoding="utf-8")
          PY

      - name: Upload high-accuracy parity artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: high-accuracy-parity-${{ github.run_id }}
          path: |
            benchmarks/outputs/diagnostics/high_accuracy_parity_report.yaml
            benchmarks/outputs/diagnostics/high_accuracy_parity_term_audit.yaml
